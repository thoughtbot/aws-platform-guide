#!/usr/bin/env ruby

require "nokogiri"
require "tempfile"

class Conversion
  def initialize(source_file, root)
    @source_file = source_file
    @source_dir = File.dirname(source_file)
    @output_file = generate_filename(source_file)
    @output_dir = File.dirname(@output_file)
    @output_file = File.join(root, @output_file)
    @output_dir = File.join(root, @output_dir)

    if @output_dir == "."
      @path_to_root = "."
    else
      @path_to_root = @output_dir.split("/").map { |_| ".." }.join("/")
    end
  end

  def run
    puts "Parsing #{@source_file}..."
    document = Nokogiri::HTML(IO.read(@source_file))

    puts "Stripping header/footer..."
    content = document.at_css("#main-content")

    puts "Removing image wrappers..."
    content.search("span.confluence-embedded-file-wrapper").each do |node|
      node.replace(node.inner_html)
    end

    puts "Rewriting internal links..."
    content.search("a").each do |node|
      rewrite_link(node)
    end

    puts "Writing temp file..."
    temp = Tempfile.new(["confluence", ".html"])
    temp.write(content.inner_html)
    temp.close

    puts "Creating directories..."
    FileUtils.mkdir_p(@output_dir)

    puts "Converting to Markdown..."
    system("pandoc --from html --to gfm #{temp.path} --output #{@output_file}", exception: true)

    puts
    puts "Wrote #{@output_file}"
  end

  private

  def generate_filename(source_path)
    page = Nokogiri::HTML(IO.read(source_path))
    breadcrumbs = page.at_css("#breadcrumb-section")
    parents = breadcrumbs.search("li").map { |bc| breadcrumb_to_file(bc.text) }
    parents = parents[2..] || []
    title = breadcrumb_to_file(page.at_css("#title-heading").text.split(":", 2).last.strip)
    [(parents + [title]).join("/"), "md"].join(".")
  end

  def breadcrumb_to_file(text)
    text.strip.downcase.gsub(/[^a-z0-9-]/, "-")
  end

  def rewrite_link(link)
    if link.attributes["href"]
      href = File.join(@source_dir, link.attributes["href"])
      if href && File.exists?(href)
        link.attributes["href"].value = File.join(@path_to_root, generate_filename(href))
      end
    end
  end
end

Conversion.new(ARGV[0], ARGV[1]).run
