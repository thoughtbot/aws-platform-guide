<!DOCTYPE html>
<html>
    <head>
        <title>AWS Platform Guide : Setup PostgreSQL Slow Query Alert</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">AWS Platform Guide</a></span>
                            </li>
                                                    <li>
                                <span><a href="AWS-Platform-Guide-Home_13697366.html">AWS Platform Guide Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="flightdeck-addons_145424396.html">flightdeck-addons</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            AWS Platform Guide : Setup PostgreSQL Slow Query Alert
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Olamide Olaoye</span>, last modified on Nov 20, 2023
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>You can enable a slow query alert to monitor all SQL queries for a PostgreSQL RDS instance and send out a notification once any query runs for more than a preset number of seconds. This feature is useful for monitoring a database for degraded performance before any impact is felt by the end user. The steps below will show how to enable a slow query logs and deliver them to <a class="external-link" href="https://aws.amazon.com/sns/" rel="nofollow">AWS SNS</a> or <a class="external-link" href="https://sentry.io/welcome/" rel="nofollow">Sentry</a>. All resources required to setup slow query notifications will be made using Terraform.</p><p /><ol start="1"><li><p>Enable query logging for PostgreSQL.<br/>The first step to setting up slow query logs is to enable query logging on the PostgreSQL RDS instance. You can enable query logs on RDS by updating either or both of these RDS parameter; <br/></p><ul><li><p><a class="external-link" href="https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-STATEMENT" rel="nofollow">log_statement</a>: Modify this parameter to determine the type of logs that should be logged regardless of execution time. The default is <strong>none</strong>. Possible options are;</p><ol start="1"><li><p><strong>all</strong>: Capture all logs .</p></li><li><p><strong>ddl</strong>: Capture all data definition language (DDL) statements such as <em>CREATE</em>, <em>ALTER</em>, and DROP.</p></li><li><p><strong>mod</strong>: Capture all DDL and data modification language (DML) statements such as <em>INSERT</em>, <em>UPDATE</em>, and <em>DELETE</em>.<br/></p></li></ol></li><li><p><a class="external-link" href="https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-MIN-DURATION-STATEMENT" rel="nofollow">log_min_duration_statement</a>: Modify this parameter to set a threshold in milliseconds for queries to be logged. This allows you to log all queries that take longer than the set parameter value.<br/><br/>The terraform code snippet below can be used to create a PostgreSQL database parameter group to export all SQL queries that run for over 5 seconds.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">resource &quot;aws_db_parameter_group&quot; &quot;postgres_databae_parameter&quot; {
  name   = &quot;postgres-database-parameter&quot;
  family = &quot;postgres14&quot;

  parameter {
    name  = &quot;log_min_duration_statement&quot;
    value = &quot;5000&quot;
  }
}</pre>
</div></div><p /></li></ul></li><li><p>Publishing slow query logs to Cloudwatch Logs:<br/>Once query logging has been enabled in the RDS postgres instance, the next step is to publish the logs data to Cloudwatch logs. To do this, you should set <code>enabled_cloudwatch_logs_exports</code> option on RDS to the preferred RDS log type that should be exported. Available options for PostgreSQL are <code>postgresql</code> and <code>upgrade</code>. For slow query logs, we will set this parameter to <code>postgresql</code>.<br/>Note:, The logs from the RDS instance will be exported to a Cloudwatch log group with this naming convention - <code>/aws/rds/instance/{my_instance}/postgresql</code>, where <code>my_instance</code> is the name of the RDS instance. A Cloudwatch log group with this name will be created automatically if doesn’t already exist. <br/>If you are using thoughtbot’s <a class="external-link" href="https://github.com/thoughtbot/terraform-aws-databases/tree/main/rds-postgres/primary-instance" rel="nofollow">terraform-aws-database</a> terraform module, you can enable this option using the terraform code snippet below along with other necessary inputs;<br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">module &quot;postgres&quot; {
  source = &quot;github.com/thoughtbot/terraform-aws-databases//rds-postgres/primary-instance?ref=v0.4.0&quot;

  ...
  enabled_cloudwatch_logs_exports = [&quot;postgresql&quot;]
  ...
}   </pre>
</div></div><p /></li><li><p>Create a Cloudwatch log group subscription to AWS SNS<br/>You can create a Log group subscription to send every message received by the Cloudwatch log group to an AWS SNS topic. For this step, we will be using a <a class="external-link" href="https://github.com/thoughtbot/flightdeck/tree/main/aws/cloudwatch-log-extract" rel="nofollow">Cloudwatch Logs extract</a> terraform module. You can review the terraform code snippet below for a sample implementation of the module.<br/><em><strong>Note</strong></em>: A destination SNS topic should be created and passed into this terraform module.<br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">module &quot;cloudwatch_log_extract&quot; {
  source = &quot;github.com/thoughtbot/flightdeck//aws/cloudwatch-log-extract?ref=v0.10.1&quot;
  
  # Enter the Source CloudWatch log group to subscribe to for log messages.
  source_cloudwatch_log_group = &quot;/aws/rds/instance/sandbox-database/postgresql&quot;
  
  # Enter a log group filter pattern to pick which logs get sent to the lambda endpoint
  log_group_filter_pattern = &quot;duration&quot;

  # Enter a log message filter expression to pick out specific details to be sent to the destination SNS topic. 
  # You may provide a regex pattern with capture groups, and enter the label for each capture group.
  log_message_filter = {
    regex_pattern = &quot;.* duration: ([0-9.]+) ms .* content: (.*)&quot;
    capture_group = {
      1 = &quot;duration&quot;,
      2 = &quot;message&quot;
    }
  }
  
  # Enter any message attribute to be added to the SNS message.
  message_attributes = {
    database = &quot;sandbox-database&quot;
  }

  # Enter the destination SNS topic
  destination_sns_topic_arn = &quot;arn:aws:sns:us-east-1:123456789:sandbox-database-sns-topic&quot; 
}
</pre>
</div></div><p /></li><li><p>Send slow query messages from AWS SNS to Sentry<br/>Lastly, you can now push the messages from SNS to Sentry. You can do this by creating an SNS subscription to the destination SNS topic used in the previous step. Once this is done, any message publised to SNS will be forwarded to Sentry. For this step, we will be using an <a class="external-link" href="https://github.com/thoughtbot/aws-sns-sentry-delivery" rel="nofollow">SNS to Sentry integration</a> terraform module. You can review the terraform code snippet below for a sample implementation of the module.<br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">module &quot;sns_sentry_delivery&quot; {
  source = &quot;github.com:thoughtbot/aws-sns-sentry-delivery?ref=v0.1.1&quot;
  
  name = &quot;sandbox-database-messages&quot;

  # Name of the AWS Secretmanager resource contaiing the sentry DSN credentials
  sentry_secret_name = sandbox-sentry-secret

  # Enter the source SNS topic
  source_sns_topic_arn = &quot;arn:aws:sns:us-east-1:123456789:sandbox-database-sns-topic&quot;
}</pre>
</div></div></li></ol><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Mar 18, 2024 10:54</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
