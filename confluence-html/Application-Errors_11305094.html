<!DOCTYPE html>
<html>
    <head>
        <title>AWS Platform Guide : Application Errors</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">AWS Platform Guide</a></span>
                            </li>
                                                    <li>
                                <span><a href="AWS-Platform-Guide-Home_13697366.html">AWS Platform Guide Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Troubleshooting_11173995.html">Troubleshooting</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            AWS Platform Guide : Application Errors
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Victoria Guido</span>, last modified by <span class='editor'> Joe Ferris</span> on Jul 14, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="ApplicationErrors-Istio/Envoy">Istio/Envoy</h2><h3 id="ApplicationErrors-UpstreamConnecterror">Upstream Connect error</h3><blockquote><p>upstream connect error or disconnect/reset before headers. reset reason: connection termination</p></blockquote><p>This error is returned by Envoy if your web server disconnects before sending a response. This could happen if:</p><ul><li><p>Your web process crashes or exits in the middle of a request.</p></li><li><p>Your web container is killed due to excessive memory usage.</p></li><li><p>Your web container is removed during a deploy or scale down event and doesn't gracefully handle termination.</p></li></ul><p>If this error is returned consistently by performing the same request, it's likely that something in the response is causing your application server to crash. Inspect the application logs to determine where the crash may be happening.</p><p>This error is most likely caused by an application crash and not by a problem in the infrastructure.</p><h2 id="ApplicationErrors-Puma">Puma</h2><h3 id="ApplicationErrors-Unabletoaddworkwhileshuttingdown">Unable to add work while shutting down</h3><p>This error occurs when Puma receives a request after the Puma server has received a SIGTERM signal.</p><p>If you receive this error, first ensure you upgrade Puma to version 5 or greater, as there is a <a class="external-link" href="https://github.com/puma/puma/pull/2122" rel="nofollow">fix</a> for a bug in Puma itself.</p><p>This can still happen in large Kubernetes deployments because of the way <a class="external-link" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination" rel="nofollow">pod termination</a> works. When a pod is scheduled to be terminated, Kubernetes will simultaneously send a SIGTERM to pod's containers and schedule the pod's <a class="external-link" href="https://stackoverflow.com/questions/52857825/what-is-an-endpoint-in-kubernetes" rel="nofollow">endpoints</a> to be removed. If a request arrives after SIGTERM is received but before the endpoints are removed, the request can be routed to a pod in a terminating state.</p><p>If you're still receiving this error after upgrading Puma, you can add a delay to your pod termination workflow to provide enough time for endpoints to be removed.</p><p>Add the following to your web container manifest:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"># Add to spec.template.spec.containers in your web deployment
lifecycle:
  preStop:
    exec:
      command: [&quot;/bin/sleep&quot;,&quot;30&quot;]
</pre>
</div></div><p>Then increase your pod's termination grace period to avoid receiving SIGKILL:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"># Add to spec.template.spec in your web deployment
terminationGracePeriodSeconds: 60
</pre>
</div></div><p>For more information, see <a class="external-link" href="https://github.com/puma/puma/blob/master/docs/kubernetes.md#graceful-shutdown-and-pod-termination" rel="nofollow">Puma documentation for Kubernetes</a>.</p><h2 id="ApplicationErrors-RDS/Postgres">RDS/Postgres</h2><h3 id="ApplicationErrors-TooManyConnections">Too Many Connections</h3><p>You may see one of these errors:</p><blockquote><p>PG::ConnectionBad: FATAL: remaining connection slots are reserved for non-replication superuser connections</p></blockquote><blockquote><p>ActiveRecord::NoDatabaseError: FATAL: sorry, too many clients already</p></blockquote><p>This means that you have already used the maximum number of connections for your Postgres instance. The maximumum number of connections varies based on the size of the instance.</p><p>You can use a console to check the number of database connections:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">% flightctl console rails dbconsole -p
postgres=&gt; show max_connections;
 max_connections
-----------------
 83
</pre>
</div></div><p>Note that some connections will be reserved for superusers:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">postgres=&gt; show superuser_reserved_connections;
 superuser_reserved_connections
--------------------------------
 3
</pre>
</div></div><p>In this example, the application is allowed to use at most 80 connections.</p><p>In order to resolve this issue, you can:</p><ul><li><p>Reduce the number of replicas running for one of your services to free up its connections.</p></li><li><p>Reduce the number of connections used by each replica.</p></li><li><p>Upgrade your database connection to allow for more connections.</p></li><li><p>Add a connection proxy to load balance connections to your database.</p></li><li><p>Change the <code>max_connections</code> setting in Postgres if you're sure it won't cause out of memory errors for your use case.</p></li></ul>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Mar 18, 2024 10:54</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
